(function(){"use strict";function Z(a){let t=0;for(let n=0;n<a.length;n++)t=Math.imul(31,t)+a.charCodeAt(n)|0;return t>>>0}function Q(a){let t=a|0;return()=>{t|=0,t=t+1831565813|0;let n=Math.imul(t^t>>>15,1|t);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}function z(a,t,n,f,{fit:y,backgroundColor:g="transparent",cornerRadius:r=0,borderEnabled:v=!1,borderWidth:l=0,borderColor:d="#ffffff",shadowEnabled:u=!1,shadowAngle:C=0,shadowDistance:Y=0,shadowBlur:A=0,shadowColor:w="#000000",effects:x=[],jitterPosition:p=0,jitterSize:s=0,jitterRotation:o=0,shape:M="rect"}){if(a.canvas.width=t.canvasWidth,a.canvas.height=t.canvasHeight,a.clearRect(0,0,a.canvas.width,a.canvas.height),g&&g!=="transparent"){if(a.save(),a.globalAlpha=1,a.fillStyle=g,M==="circle"){const I=t.canvasWidth/2,h=t.canvasHeight/2,m=Math.min(t.canvasWidth,t.canvasHeight)/2;a.beginPath(),a.arc(I,h,m,0,Math.PI*2),a.fill()}else a.fillRect(0,0,a.canvas.width,a.canvas.height);a.restore()}const W=t.items.length?Math.max(...t.items.map(I=>Math.min(I.w,I.h))):0,k=r>0&&W>0?r/100*(W/2):0,i=t.items.length?t.items.reduce((I,h)=>I+Math.min(h.w,h.h),0)/t.items.length:0,H=v&&l>0&&i>0?{color:d,width:l/100*(i*.1)}:void 0,X=u&&(Y>0||A>0)&&i>0?(()=>{const I=Y/100*(i*.2),h=A/100*(i*.2),m=C*Math.PI/180;return{color:w,offsetX:I*Math.cos(m),offsetY:I*Math.sin(m),blur:h}})():void 0;for(const I of t.items){const h=n[I.imageIndex],m=h.id||h.src||`img-${I.imageIndex}`,e=Q(Z(String(m))^I.imageIndex),b=Math.min(I.w,I.h)*.25*(Math.max(0,p)/100),c=.3*(Math.max(0,s)/100),S=Math.max(0,o),P=V=>(e()-.5)*2*V,B=1+P(c),R=P(b),q=P(b),O=P(S)*(Math.PI/180),E=I.x+I.w/2,_=I.y+I.h/2,L=I.w*B,N=I.h*B,G=E+R-L/2,J=_+q-N/2;nt(a,{...I,x:G,y:J,w:L,h:N},n[I.imageIndex],f[I.imageIndex],{fit:y,cornerRadiusTargetPx:k,border:H,dropShadow:X,effects:x,rotationRad:O,shape:M})}}function j(a,t,n,f,y,g,r="rect"){if(r==="circle"){const v=Math.min(f,y)/2;a.arc(t+f/2,n+y/2,v,0,Math.PI*2),a.closePath();return}if(g>0){const v=Math.min(f,y)/2,l=Math.min(g,v);a.moveTo(t+l,n),a.lineTo(t+f-l,n),a.arcTo(t+f,n,t+f,n+l,l),a.lineTo(t+f,n+y-l),a.arcTo(t+f,n+y,t+f-l,n+y,l),a.lineTo(t+l,n+y),a.arcTo(t,n+y,t,n+y-l,l),a.lineTo(t,n+l),a.arcTo(t,n,t+l,n,l),a.closePath()}else a.rect(t,n,f,y)}function tt(a,t,n,f,y,g,r="overlay"){const v=document.createElement("canvas");v.width=Math.max(1,Math.floor(f)),v.height=Math.max(1,Math.floor(y));const l=v.getContext("2d");if(!l)return;const d=l.createImageData(v.width,v.height),u=d.data,C=Math.max(0,Math.min(100,g))/100*64;for(let Y=0;Y<u.length;Y+=4){const A=Math.random()<.5?0:255;u[Y]=A,u[Y+1]=A,u[Y+2]=A,u[Y+3]=C}l.putImageData(d,0,0),a.save(),a.globalCompositeOperation=r,a.drawImage(v,t,n,f,y),a.restore()}function et(a,t,n,f,y,g,r="overlay"){a.save();const v=t+f/2,l=n+y/2,d=Math.sqrt(f*f+y*y)/2,u=a.createRadialGradient(v,l,0,v,l,d);u.addColorStop(0,"rgba(0, 0, 0, 0)"),u.addColorStop(1,`rgba(0, 0, 0, ${g/100})`),a.globalCompositeOperation=r,a.fillStyle=u,a.beginPath(),a.rect(t,n,f,y),a.fill(),a.restore()}function at(a,t,n,f,y,g){const r=g/100,l=a.getImageData(t,n,f,y).data,d=f,u=y,C=[0,-r,0,-r,1+4*r,-r,0,-r,0],Y=new Uint8ClampedArray(l);for(let A=1;A<u-1;A++)for(let w=1;w<d-1;w++){let x=0,p=0,s=0;for(let M=-1;M<=1;M++)for(let W=-1;W<=1;W++){const k=((A+M)*d+(w+W))*4,i=C[(M+1)*3+(W+1)];x+=l[k]*i,p+=l[k+1]*i,s+=l[k+2]*i}const o=(A*d+w)*4;Y[o]=Math.max(0,Math.min(255,x)),Y[o+1]=Math.max(0,Math.min(255,p)),Y[o+2]=Math.max(0,Math.min(255,s))}a.putImageData(new ImageData(Y,d,u),t,n)}function nt(a,t,n,f,{fit:y,cornerRadiusTargetPx:g=0,border:r,dropShadow:v,effects:l=[],rotationRad:d=0,shape:u="rect"}){const{x:C,y:Y,w:A,h:w}=t,x=f.width/f.height,p=A/w;let s=A,o=w,M=0,W=0,k=f.width,i=f.height;y?p>x?(k=f.width,i=k/p,W=(f.height-i)/2):(i=f.height,k=i*p,M=(f.width-k)/2):p>x?(s=w*x,o=w):(s=A,o=A/x);const H=C+(A-s)/2,X=Y+(w-o)/2,I=H+s/2,h=X+o/2;a.save(),a.translate(I,h),d&&a.rotate(d),a.translate(-I,-h);const m=g>0?Math.min(g,Math.min(s,o)/2):0;v&&(a.save(),a.shadowColor=v.color,a.shadowBlur=v.blur,a.shadowOffsetX=v.offsetX,a.shadowOffsetY=v.offsetY,a.beginPath(),j(a,H,X,s,o,m,u),a.fillStyle="black",a.fill(),a.restore()),a.save();const e=[],b=[];if(l.length>0){for(const c of l)switch(c.type){case"blur":e.push(`blur(${c.value}px)`);break;case"brightness":e.push(`brightness(${c.value}%)`);break;case"contrast":e.push(`contrast(${c.value}%)`);break;case"grayscale":e.push(`grayscale(${c.value}%)`);break;case"hue-rotate":e.push(`hue-rotate(${c.value}deg)`);break;case"invert":e.push(`invert(${c.value}%)`);break;case"saturate":e.push(`saturate(${c.value}%)`);break;case"sepia":e.push(`sepia(${c.value}%)`);break;case"grain":case"vignette":case"sharpen":case"bloom":b.push(c);break}e.length>0&&(a.filter=e.join(" "))}a.beginPath(),j(a,H,X,s,o,m,u),a.clip(),a.drawImage(f,M,W,k,i,H,X,s,o);for(const c of b)switch(c.type){case"grain":tt(a,H,X,s,o,c.value,c.blendMode??"overlay");break;case"vignette":et(a,H,X,s,o,c.value,c.blendMode??"overlay");break;case"sharpen":at(a,H,X,s,o,c.value);break;case"bloom":{const S=Math.max(0,Math.min(100,c.value))/100,P=Math.max(0,c.blur??10),B=c.blendMode??"overlay";a.save(),a.globalCompositeOperation=B,a.globalAlpha=S,a.filter=`blur(${P}px)`,a.drawImage(f,M,W,k,i,H,X,s,o),a.restore();break}}a.restore(),r&&r.width>0&&(a.save(),a.strokeStyle=r.color,a.lineWidth=r.width,a.beginPath(),j(a,H,X,s,o,m,u),a.stroke(),a.restore()),n.label&&(a.font="bold 14px sans-serif",a.fillStyle="#fff",a.fillText(n.label,H+4,X+16)),n.description&&(a.font="12px sans-serif",a.fillStyle="#fff",a.fillText(n.description,H+4,X+o-6)),a.restore()}function ot(a,t="both"){const n=a.map(g=>g.width),f=a.map(g=>g.height);n.sort((g,r)=>g-r),f.sort((g,r)=>g-r);const y=Math.floor(a.length/2);return{width:t==="height"?0:n[y],height:t==="width"?0:f[y]}}const K=3200;function st({loadedImages:a,images:t,normalizeSize:n,layout:f,spacing:y=0,fit:g=!1,scale:r=1,justify:v=!1}){if(!a||!a.length||a.length!==t.length)return{canvasWidth:1,canvasHeight:1,items:[]};let l={width:0,height:0};if(n){let s="both";f==="single-row"?s="height":(f==="single-column"||f==="masonry")&&(s="width"),l=ot(a,s)}const d=a.map(s=>{let o=s.width,M=s.height;if(n){if(f==="single-row"&&l.height)o=Math.round(l.height*(o/M)),M=l.height;else if((f==="single-column"||f==="masonry")&&l.width)M=Math.round(l.width*(M/o)),o=l.width;else if(l.width&&l.height){const W=o/M;W>l.width/l.height?(o=l.width,M=Math.round(l.width/W)):(M=l.height,o=Math.round(l.height*W))}}return{w:o,h:M}}),u=d.reduce((s,o)=>s+o.w,0)/d.length,C=d.reduce((s,o)=>s+o.h,0)/d.length,Y=y/100*.5,A=Math.round(Y*((u+C)/2)),w=(()=>{switch(f){case"single-row":return rt(a,d,A,g);case"single-column":return ht(a,d,A,g);case"grid":return lt(a,d,A,g,v);case"masonry":return it(a,d,A,g,v);case"packed":return mt(d,A,v);case"cluster":return ut(d,A);case"squarified":return dt(d,A);case"lanes":return ct(a,d,A,g,v);case"bubble":return ft(a,d,A);default:return{canvasWidth:800,canvasHeight:600,items:[]}}})(),x=Math.min(K/w.canvasWidth,K/w.canvasHeight),p={canvasWidth:w.canvasWidth*x,canvasHeight:w.canvasHeight*x,items:w.items.map(s=>({...s,x:s.x*x,y:s.y*x,w:s.w*x,h:s.h*x}))};return{canvasWidth:p.canvasWidth*r,canvasHeight:p.canvasHeight*r,items:p.items.map(s=>({...s,x:s.x*r,y:s.y*r,w:s.w*r,h:s.h*r}))}}function rt(a,t,n=0,f=!1){const y=Math.max(...t.map(d=>d.h))+2*n;let g,r=[];if(f){const d=y-2*n;r=a.map(u=>Math.round(d*(u.width/u.height))),g=r.reduce((u,C,Y)=>u+C+(Y>0?n:0),0)+2*n}else g=t.reduce((d,u,C)=>d+u.w+(C>0?n:0),0)+2*n;const v=[];let l=n;return a.forEach((d,u)=>{const C=f?r[u]:t[u].w,Y=f?y-2*n:t[u].h;v.push({x:l,y:n,w:C,h:Y,imageIndex:u}),l+=C+n}),{canvasWidth:g,canvasHeight:y,items:v}}function ht(a,t,n=0,f=!1){const y=Math.max(...t.map(d=>d.w))+2*n;let g,r=[];if(f){const d=y-2*n;r=a.map(u=>Math.round(d*(u.height/u.width))),g=r.reduce((u,C,Y)=>u+C+(Y>0?n:0),0)+2*n}else g=t.reduce((d,u,C)=>d+u.h+(C>0?n:0),0)+2*n;const v=[];let l=n;return a.forEach((d,u)=>{if(f){const C=y-2*n,Y=r[u];v.push({x:(y-C)/2,y:l,w:C,h:Y,imageIndex:u}),l+=Y+n}else{const C=(y-2*n-t[u].w)/2+n;v.push({x:C,y:l,w:t[u].w,h:t[u].h,imageIndex:u}),l+=t[u].h+n}}),{canvasWidth:y,canvasHeight:g,items:v}}function lt(a,t,n=0,f=!1,y=!1){const g=a.length,r=Math.ceil(Math.sqrt(g)),v=Math.ceil(g/r),l=Math.max(...t.map(x=>x.w)),d=Math.max(...t.map(x=>x.h)),u=r*l+(r-1)*n+2*n,C=v*d+(v-1)*n+2*n,Y=[],A=g%r,w=A>0&&A<r;for(let x=0;x<g;++x){const p=x%r,s=Math.floor(x/r),o=s===v-1;if(y&&w&&o){const M=A,W=u-2*n,k=(M-1)*n,i=(W-k)/M,H=p*(i+n)+n,X=s*(d+n)+n;if(f)Y.push({x:H,y:X,w:i,h:d,imageIndex:x});else{const I=t[x].w,h=t[x].h,m=H+(i-I)/2,e=X+(d-h)/2;Y.push({x:m,y:e,w:I,h,imageIndex:x})}}else{const M=p*(l+n)+n,W=s*(d+n)+n;if(f)Y.push({x:M,y:W,w:l,h:d,imageIndex:x});else{const k=t[x].w,i=t[x].h,H=M+(l-k)/2,X=W+(d-i)/2;Y.push({x:H,y:X,w:k,h:i,imageIndex:x})}}}return{canvasWidth:u,canvasHeight:C,items:Y}}function it(a,t,n=0,f=!1,y=!1){const g=a.length,r=Math.ceil(Math.sqrt(g)),v=Array(r).fill(0).map((i,H)=>Math.max(...t.filter((X,I)=>I%r===H).map(X=>X.w),0));for(let i=0;i<r-1;++i)v[i]+=n;const l=Array(r).fill(0),d=[],u=[];for(let i=0;i<g;++i){let H=0;for(let b=1;b<r;++b)l[b]<l[H]&&(H=b);const X=v.slice(0,H).reduce((b,c)=>b+c,0),I=v[H]-(H<r-1?n:0),h=l[H]+(l[H]>0?n:0);let m=t[i].w,e=t[i].h;f&&(m=I,e=Math.round(m*(a[i].height/a[i].width))),d.push({x:X+n,y:h+n,w:m,h:e,imageIndex:i}),l[H]+=e+(l[H]>0?n:0),u[i]=H}const C=v.reduce((i,H)=>i+H,0)+2*n,Y=Math.max(...l)+2*n;if(!y||g===0)return{canvasWidth:C,canvasHeight:Y,items:d};const A=Math.max(...l,0),w=Array.from({length:r},()=>[]);d.forEach((i,H)=>w[u[H]].push(H));const x=Array(r).fill(0),p=Array(g);for(let i=0;i<r;i++){const H=w[i];if(H.length===0)continue;const X=Math.max(0,H.length-1)*n,I=H.reduce((e,b)=>e+d[b].h,0),h=I>0?(A-X)/I:1;let m=n;for(const e of H){const b=d[e],c=b.w*h,S=b.h*h;p[e]={w:c,h:S,y:m},m+=S+n,x[i]=Math.max(x[i],c)}}const s=[];let o=n;for(let i=0;i<r;i++)s[i]=o,o+=(x[i]||0)+n;const M=d.map((i,H)=>{const X=u[H],I=p[H],h=x[X]||i.w;return{x:s[X]+(h-I.w)/2,y:I.y,w:I.w,h:I.h,imageIndex:i.imageIndex}}),W=Math.max(o,C),k=Math.max(A+n,Y);return{canvasWidth:W,canvasHeight:k,items:M}}function ct(a,t,n=0,f=!1,y=!1){const g=a.length;if(g===0)return{canvasWidth:0,canvasHeight:0,items:[]};const r=Math.max(1,Math.ceil(Math.sqrt(g))),v=[],l=Array(r).fill(0),d=Array(r).fill(0),u=Array(g);for(let h=0;h<g;h++){let m=0;for(let b=1;b<r;b++)d[b]<d[m]&&(m=b);v.push({i:h,row:m}),u[h]=m;const e=t[h].h;l[m]=Math.max(l[m],e),d[m]+=t[h].w+(d[m]>0?n:0)}const C=[];let Y=n;for(let h=0;h<r;h++)C[h]=Y,Y+=l[h]+n;const A=Array(r).fill(0),w=Array(g);for(const{i:h,row:m}of v){const e=a[h].width/a[h].height,b=f?l[m]:t[h].h,c=f?Math.round(b*e):t[h].w,S=n+A[m],P=C[m];w[h]={x:S,y:P,w:c,h:b,imageIndex:h},A[m]+=c+n}const x=Math.max(...A,0)+n,p=Y;if(!y)return{canvasWidth:x,canvasHeight:p,items:w};const s=Math.max(...A,0),o=Array.from({length:r},()=>[]);w.forEach((h,m)=>o[u[m]].push(m));const M=Array(r).fill(0),W=Array(g);for(let h=0;h<r;h++){const m=o[h];if(m.length===0)continue;const e=m.length*n,b=m.reduce((P,B)=>P+w[B].w,0),c=b>0?(s-e)/b:1;let S=n;for(const P of m){const B=w[P],R=B.w*c,q=B.h*c;W[P]={w:R,h:q,x:S},S+=R+n,M[h]=Math.max(M[h],q)}}const k=[];let i=n;for(let h=0;h<r;h++)k[h]=i,i+=(M[h]||0)+n;const H=w.map((h,m)=>{const e=u[m],b=W[m],c=M[e]||h.h,S=k[e]+(c-b.h)/2;return{x:b.x,y:S,w:b.w,h:b.h,imageIndex:h.imageIndex}}),X=Math.max(s+n,x),I=Math.max(i,p);return{canvasWidth:X,canvasHeight:I,items:H}}function ft(a,t,n=0){const f=t.length;if(f===0)return{canvasWidth:0,canvasHeight:0,items:[]};const y=t.map((o,M)=>{const W=Math.min(o.w,o.h);return{i:M,side:W,r:W/2,x:0,y:0}}).sort((o,M)=>M.side-o.side),g=Math.PI*2/f,r=y[0].r+n;y.forEach((o,M)=>{const W=M*g,k=1+M%3*.05,i=r*k+M*.15*n;o.x=Math.cos(W)*i,o.y=Math.sin(W)*i});const v=220,l=n;for(let o=0;o<v;o++){for(let W=0;W<f;W++)for(let k=W+1;k<f;k++){const i=y[W],H=y[k];let X=H.x-i.x,I=H.y-i.y,h=Math.hypot(X,I);const m=i.r+H.r+l;if(h===0&&(X=.01,I=0,h=.01),h<m){const b=(m-h)/h*.5,c=X*b,S=I*b;i.x-=c,i.y-=S,H.x+=c,H.y+=S}}const M=.02;for(const W of y)W.x*=1-M,W.y*=1-M}let d=1/0,u=1/0,C=-1/0,Y=-1/0;for(const o of y)d=Math.min(d,o.x-o.r),u=Math.min(u,o.y-o.r),C=Math.max(C,o.x+o.r),Y=Math.max(Y,o.y+o.r);const A=-d+n,w=-u+n,x=C-d+n*2,p=Y-u+n*2,s=y.map(o=>({x:o.x-o.r+A,y:o.y-o.r+w,w:o.side,h:o.side,imageIndex:o.i}));return s.sort((o,M)=>o.imageIndex-M.imageIndex),{canvasWidth:x,canvasHeight:p,items:s}}function mt(a,t=0,n=!1){const f=a.reduce((e,b)=>e+b.w*b.h,0),y=Math.max(...a.map(e=>e.w)),g=Math.max(...a.map(e=>e.h));let r=Math.max(Math.ceil(Math.sqrt(f)),y),v=Math.max(Math.ceil(f/r),g);r+=t*2,v+=t*2;function l(e,b,c,S){return{x:e,y:b,w:c,h:S,used:!1,down:null,right:null,imgIdx:null}}function d(e,b,c,S){return e.used?d(e.right,b,c,S)||d(e.down,b,c,S):b<=e.w&&c<=e.h?(e.used=!0,e.imgIdx=S,e.down=l(e.x,e.y+c+t,e.w,e.h-c-t),e.right=l(e.x+b+t,e.y,e.w-b-t,c),{x:e.x,y:e.y}):null}const u=a.map((e,b)=>({i:b,w:e.w,h:e.h,key:Math.max(e.w,e.h),area:e.w*e.h})).sort((e,b)=>b.key-e.key||b.area-e.area),C=Array(a.length);let Y=!1,A=0,w=null;for(;!Y&&A<10;){w=l(t,t,r-2*t,v-2*t);let e=!1;for(let b=0;b<u.length;++b){const{w:c,h:S,i:P}=u[b],B=d(w,c,S,P);if(!B){e=!0;break}C[P]=B}e?(r<=v?r=Math.round(r*1.2):v=Math.round(v*1.2),A++):Y=!0}const x=a.map((e,b)=>({x:C[b].x,y:C[b].y,w:e.w,h:e.h,imageIndex:b}));if(!n||!w)return{canvasWidth:r,canvasHeight:v,items:x};function p(e){const b=[],c=[],S=e.right?p(e.right):null,P=e.down?p(e.down):null;S&&b.push(S),P&&b.push(P),e.right&&e.right.imgIdx!==null&&c.push(e.right.imgIdx),e.down&&e.down.imgIdx!==null&&c.push(e.down.imgIdx),e.imgIdx!==null&&c.push(e.imgIdx);const B=e.imgIdx!==null?(()=>{const T=x[e.imgIdx];return{minX:T.x,maxX:T.x+T.w,minY:T.y,maxY:T.y+T.h}})():null,R=[...b,...B?[B]:[]].reduce((T,$)=>T?{minX:Math.min(T.minX,$.minX),maxX:Math.max(T.maxX,$.maxX),minY:Math.min(T.minY,$.minY),maxY:Math.max(T.maxY,$.maxY)}:{...$},null);if(!R)return null;if(c.length===1&&e.imgIdx!==null){const T=e.imgIdx;return x[T]={...x[T],x:e.x,y:e.y,w:e.w,h:e.h},{minX:e.x,maxX:e.x+e.w,minY:e.y,maxY:e.y+e.h}}const O=R.maxX-R.minX,E=R.maxY-R.minY,_=O>0?e.w/O:1,L=E>0?e.h/E:1;function N(T){if(T.imgIdx!==null){const $=x[T.imgIdx];x[T.imgIdx]={...$,x:e.x+($.x-R.minX)*_,y:e.y+($.y-R.minY)*L,w:$.w*_,h:$.h*L}}T.right&&N(T.right),T.down&&N(T.down)}N(e);const G=e.x+(R.minX-R.minX)*_,J=e.x+(R.maxX-R.minX)*_,V=e.y+(R.minY-R.minY)*L,wt=e.y+(R.maxY-R.minY)*L;return{minX:G,maxX:J,minY:V,maxY:wt}}p(w);const s=Math.min(...x.map(e=>e.x),t),o=Math.max(...x.map(e=>e.x+e.w),t),M=Math.min(...x.map(e=>e.y),t),W=Math.max(...x.map(e=>e.y+e.h),t),k=o-s,i=W-M,H=r-t*2,X=v-t*2,I=k>0?H/k:1,h=i>0?X/i:1,m=x.map(e=>({x:t+(e.x-s)*I,y:t+(e.y-M)*h,w:e.w*I,h:e.h*h,imageIndex:e.imageIndex}));return{canvasWidth:r,canvasHeight:v,items:m}}function ut(a,t=0){const n=a.map((s,o)=>({...s,i:o,area:s.w*s.h}));n.sort((s,o)=>o.area-s.area);const f=[];f.push({x:0,y:0,w:n[0].w,h:n[0].h,i:n[0].i});let y=0,g=0,r=n[0].w,v=n[0].h;function l(){const s=[];return f.forEach((o,M)=>{s.push({x:o.x+o.w+t,y:o.y,align:"left",anchorIdx:M}),s.push({x:o.x-t,y:o.y,align:"right",anchorIdx:M}),s.push({x:o.x,y:o.y-t,align:"bottom",anchorIdx:M}),s.push({x:o.x,y:o.y+o.h+t,align:"top",anchorIdx:M}),s.push({x:o.x-t,y:o.y-t,align:"corner-topleft",anchorIdx:M}),s.push({x:o.x+o.w+t,y:o.y-t,align:"corner-topright",anchorIdx:M}),s.push({x:o.x-t,y:o.y+o.h+t,align:"corner-bottomleft",anchorIdx:M}),s.push({x:o.x+o.w+t,y:o.y+o.h+t,align:"corner-bottomright",anchorIdx:M})}),s}const d=f[0].x+f[0].w/2,u=f[0].y+f[0].h/2;function C(s,o,M){const W=s.x+o/2,k=s.y+M/2;return Math.sqrt((W-d)*(W-d)+(k-u)*(k-u))}for(let s=1;s<n.length;++s){const{w:o,h:M,i:W}=n[s];let k=1/0,i=null;const H=l();for(const X of H){const I=[{x:X.x,y:X.y},{x:X.x-o,y:X.y},{x:X.x,y:X.y-M},{x:X.x-o,y:X.y-M}];for(const h of I){let m=!1;for(const c of f)if(h.x<c.x+c.w+t&&h.x+o+t>c.x&&h.y<c.y+c.h+t&&h.y+M+t>c.y){m=!0;break}if(m)continue;let e=!1;for(const c of f)if(Math.abs(h.x+o+t-c.x)<1e-6&&h.y<c.y+c.h+t&&h.y+M>c.y||Math.abs(h.x-(c.x+c.w+t))<1e-6&&h.y<c.y+c.h+t&&h.y+M>c.y||Math.abs(h.y+M+t-c.y)<1e-6&&h.x<c.x+c.w+t&&h.x+o>c.x||Math.abs(h.y-(c.y+c.h+t))<1e-6&&h.x<c.x+c.w+t&&h.x+o>c.x){e=!0;break}if(!e)continue;const b=C(h,o,M);b<k&&(k=b,i=h)}}i||(i={x:y,y:v+t}),f.push({x:i.x,y:i.y,w:o,h:M,i:W}),y=Math.min(y,i.x),g=Math.min(g,i.y),r=Math.max(r,i.x+o),v=Math.max(v,i.y+M)}const Y=-y,A=-g,w=r-y+2*t,x=v-g+2*t,p=f.map(s=>({x:s.x+Y+t,y:s.y+A+t,w:a[s.i].w,h:a[s.i].h,imageIndex:s.i}));return{canvasWidth:w,canvasHeight:x,items:p}}function dt(a,t=0){const n=a.reduce((w,x)=>w+x.w*x.h,0),f=a.reduce((w,x)=>w+x.w/x.h,0)/a.length;let y=Math.sqrt(n/f),g=f*y;g=Math.round(g),y=Math.round(y);const r=a.map((w,x)=>({...w,i:x,area:w.w*w.h,x:0,y:0,rw:0,rh:0}));r.sort((w,x)=>x.area-w.area);function v(w,x){if(w.length===0||x===0)return 1/0;const s=w.reduce((M,W)=>M+W.area,0)/x;let o=0;for(const M of w){const W=M.area/s,k=Math.max(W/s,s/W);o=Math.max(o,k)}return o}function l(w,x,p,s,o){if(w.length===0)return;if(w.length===1){w[0].x=x,w[0].y=p,w[0].rw=s,w[0].rh=o;return}const M=s>o;let W=[],k=0;if(M){const i=s;for(let m=1;m<=w.length;m++){const e=w.slice(0,m),b=v(e,i);if(m===1)W=e,k=m;else{const c=v(w.slice(0,m-1),i);if(b<c)W=e,k=m;else break}}const X=W.reduce((m,e)=>m+e.area,0)/i;let I=x;for(const m of W){const e=m.area/X;m.x=I,m.y=p,m.rw=e-t,m.rh=X-t,I+=e}const h=w.slice(k);h.length>0&&l(h,x,p+X,s,o-X)}else{const i=o;for(let m=1;m<=w.length;m++){const e=w.slice(0,m),c=e.reduce((P,B)=>P+B.area,0)/i;let S=0;for(const P of e){const B=P.area/c,R=Math.max(c/B,B/c);S=Math.max(S,R)}if(m===1)W=e,k=m;else{const P=w.slice(0,m-1),R=P.reduce((O,E)=>O+E.area,0)/i;let q=0;for(const O of P){const E=O.area/R,_=Math.max(R/E,E/R);q=Math.max(q,_)}if(S<q)W=e,k=m;else break}}const X=W.reduce((m,e)=>m+e.area,0)/i;let I=p;for(const m of W){const e=m.area/X;m.x=x,m.y=I,m.rw=X-t,m.rh=e-t,I+=e}const h=w.slice(k);h.length>0&&l(h,x+X,p,s-X,o)}}const d=g-2*t,u=y-2*t;l(r,t,t,d,u);let C=0,Y=0;for(const w of r)C=Math.max(C,w.x+w.rw),Y=Math.max(Y,w.y+w.rh);g=Math.round(C+t),y=Math.round(Y+t);const A=r.map(w=>{const x=w.x,p=w.y,s=w.rw,o=w.rh;return{x,y:p,w:s,h:o,imageIndex:w.i}});return{canvasWidth:g,canvasHeight:y,items:A}}let U=null,F=null,D=null;self.onmessage=async a=>{if(a.data.type==="compose"){self.postMessage({type:"start"});try{const{offscreenCanvas:t,images:n,loadedImgs:f,options:y}=a.data;if(f&&(D&&D.forEach(u=>u.close()),D=f),!D||D.length!==n.length){self.postMessage({type:"error",error:"No bitmaps available in worker"});return}const g={images:n,loadedImages:D,normalizeSize:y.normalizeSize,layout:y.layout,spacing:y.spacing,fit:y.fit,scale:y.scale,justify:y.justify},r=JSON.stringify({...g,images:g.images.map(u=>[u.id,u.width,u.height]),dims:g.loadedImages.map(u=>[u.width,u.height])});let v;U===r&&F?v=F:(v=st(g),U=r,F=v),t.width=v.canvasWidth,t.height=v.canvasHeight;const l=t.getContext("2d");if(!l){self.postMessage({type:"error",error:"Failed to get 2d context from offscreen canvas"});return}z(l,v,n,D,y);const d=t.transferToImageBitmap();self.postMessage({type:"complete",canvasWidth:t.width,canvasHeight:t.height,imageBitmap:d},{transfer:[d]})}catch(t){self.postMessage({type:"error",error:t instanceof Error?t.message:"Unknown error in draw worker"})}}}})();
