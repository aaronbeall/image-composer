(function(){"use strict";function U(a){let t=0;for(let n=0;n<a.length;n++)t=Math.imul(31,t)+a.charCodeAt(n)|0;return t>>>0}function Z(a){let t=a|0;return()=>{t|=0,t=t+1831565813|0;let n=Math.imul(t^t>>>15,1|t);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}function Q(a,t,n,f,{fit:x,backgroundColor:g="transparent",cornerRadius:r=0,borderEnabled:v=!1,borderWidth:l=0,borderColor:u="#ffffff",shadowEnabled:y=!1,shadowAngle:C=0,shadowDistance:Y=0,shadowBlur:A=0,shadowColor:d="#000000",effects:w=[],jitterPosition:S=0,jitterSize:s=0,jitterRotation:o=0,shape:M="rect"}){if(a.canvas.width=t.canvasWidth,a.canvas.height=t.canvasHeight,a.clearRect(0,0,a.canvas.width,a.canvas.height),g&&g!=="transparent"){if(a.save(),a.globalAlpha=1,a.fillStyle=g,M==="circle"){const I=t.canvasWidth/2,h=t.canvasHeight/2,m=Math.min(t.canvasWidth,t.canvasHeight)/2;a.beginPath(),a.arc(I,h,m,0,Math.PI*2),a.fill()}else a.fillRect(0,0,a.canvas.width,a.canvas.height);a.restore()}const W=t.items.length?Math.max(...t.items.map(I=>Math.min(I.w,I.h))):0,k=r>0&&W>0?r/100*(W/2):0,i=t.items.length?t.items.reduce((I,h)=>I+Math.min(h.w,h.h),0)/t.items.length:0,H=v&&l>0&&i>0?{color:u,width:l/100*(i*.1)}:void 0,X=y&&(Y>0||A>0)&&i>0?(()=>{const I=Y/100*(i*.2),h=A/100*(i*.2),m=C*Math.PI/180;return{color:d,offsetX:I*Math.cos(m),offsetY:I*Math.sin(m),blur:h}})():void 0;for(const I of t.items){const h=n[I.imageIndex],m=h.id||h.src||`img-${I.imageIndex}`,e=Z(U(String(m))^I.imageIndex),b=Math.min(I.w,I.h)*.25*(Math.max(0,S)/100),c=.3*(Math.max(0,s)/100),p=Math.max(0,o),P=J=>(e()-.5)*2*J,$=1+P(c),R=P(b),B=P(b),O=P(p)*(Math.PI/180),E=I.x+I.w/2,_=I.y+I.h/2,D=I.w*$,L=I.h*$,F=E+R-D/2,G=_+B-L/2;at(a,{...I,x:F,y:G,w:D,h:L},n[I.imageIndex],f[I.imageIndex],{fit:x,cornerRadiusTargetPx:k,border:H,dropShadow:X,effects:w,rotationRad:O,shape:M})}}function N(a,t,n,f,x,g,r="rect"){if(r==="circle"){const v=Math.min(f,x)/2;a.arc(t+f/2,n+x/2,v,0,Math.PI*2),a.closePath();return}if(g>0){const v=Math.min(f,x)/2,l=Math.min(g,v);a.moveTo(t+l,n),a.lineTo(t+f-l,n),a.arcTo(t+f,n,t+f,n+l,l),a.lineTo(t+f,n+x-l),a.arcTo(t+f,n+x,t+f-l,n+x,l),a.lineTo(t+l,n+x),a.arcTo(t,n+x,t,n+x-l,l),a.lineTo(t,n+l),a.arcTo(t,n,t+l,n,l),a.closePath()}else a.rect(t,n,f,x)}function z(a,t,n,f,x,g,r="overlay"){const v=document.createElement("canvas");v.width=Math.max(1,Math.floor(f)),v.height=Math.max(1,Math.floor(x));const l=v.getContext("2d");if(!l)return;const u=l.createImageData(v.width,v.height),y=u.data,C=Math.max(0,Math.min(100,g))/100*64;for(let Y=0;Y<y.length;Y+=4){const A=Math.random()<.5?0:255;y[Y]=A,y[Y+1]=A,y[Y+2]=A,y[Y+3]=C}l.putImageData(u,0,0),a.save(),a.globalCompositeOperation=r,a.drawImage(v,t,n,f,x),a.restore()}function tt(a,t,n,f,x,g,r="overlay"){a.save();const v=t+f/2,l=n+x/2,u=Math.sqrt(f*f+x*x)/2,y=a.createRadialGradient(v,l,0,v,l,u);y.addColorStop(0,"rgba(0, 0, 0, 0)"),y.addColorStop(1,`rgba(0, 0, 0, ${g/100})`),a.globalCompositeOperation=r,a.fillStyle=y,a.beginPath(),a.rect(t,n,f,x),a.fill(),a.restore()}function et(a,t,n,f,x,g){const r=g/100,l=a.getImageData(t,n,f,x).data,u=f,y=x,C=[0,-r,0,-r,1+4*r,-r,0,-r,0],Y=new Uint8ClampedArray(l);for(let A=1;A<y-1;A++)for(let d=1;d<u-1;d++){let w=0,S=0,s=0;for(let M=-1;M<=1;M++)for(let W=-1;W<=1;W++){const k=((A+M)*u+(d+W))*4,i=C[(M+1)*3+(W+1)];w+=l[k]*i,S+=l[k+1]*i,s+=l[k+2]*i}const o=(A*u+d)*4;Y[o]=Math.max(0,Math.min(255,w)),Y[o+1]=Math.max(0,Math.min(255,S)),Y[o+2]=Math.max(0,Math.min(255,s))}a.putImageData(new ImageData(Y,u,y),t,n)}function at(a,t,n,f,{fit:x,cornerRadiusTargetPx:g=0,border:r,dropShadow:v,effects:l=[],rotationRad:u=0,shape:y="rect"}){const{x:C,y:Y,w:A,h:d}=t,w=f.width/f.height,S=A/d;let s=A,o=d,M=0,W=0,k=f.width,i=f.height;x?S>w?(k=f.width,i=k/S,W=(f.height-i)/2):(i=f.height,k=i*S,M=(f.width-k)/2):S>w?(s=d*w,o=d):(s=A,o=A/w);const H=C+(A-s)/2,X=Y+(d-o)/2,I=H+s/2,h=X+o/2;a.save(),a.translate(I,h),u&&a.rotate(u),a.translate(-I,-h);const m=g>0?Math.min(g,Math.min(s,o)/2):0;v&&(a.save(),a.shadowColor=v.color,a.shadowBlur=v.blur,a.shadowOffsetX=v.offsetX,a.shadowOffsetY=v.offsetY,a.beginPath(),N(a,H,X,s,o,m,y),a.fillStyle="black",a.fill(),a.restore()),a.save();const e=[],b=[];if(l.length>0){for(const c of l)switch(c.type){case"blur":e.push(`blur(${c.value}px)`);break;case"brightness":e.push(`brightness(${c.value}%)`);break;case"contrast":e.push(`contrast(${c.value}%)`);break;case"grayscale":e.push(`grayscale(${c.value}%)`);break;case"hue-rotate":e.push(`hue-rotate(${c.value}deg)`);break;case"invert":e.push(`invert(${c.value}%)`);break;case"saturate":e.push(`saturate(${c.value}%)`);break;case"sepia":e.push(`sepia(${c.value}%)`);break;case"grain":case"vignette":case"sharpen":case"bloom":b.push(c);break}e.length>0&&(a.filter=e.join(" "))}a.beginPath(),N(a,H,X,s,o,m,y),a.clip(),a.drawImage(f,M,W,k,i,H,X,s,o);for(const c of b)switch(c.type){case"grain":z(a,H,X,s,o,c.value,c.blendMode??"overlay");break;case"vignette":tt(a,H,X,s,o,c.value,c.blendMode??"overlay");break;case"sharpen":et(a,H,X,s,o,c.value);break;case"bloom":{const p=Math.max(0,Math.min(100,c.value))/100,P=Math.max(0,c.blur??10),$=c.blendMode??"overlay";a.save(),a.globalCompositeOperation=$,a.globalAlpha=p,a.filter=`blur(${P}px)`,a.drawImage(f,M,W,k,i,H,X,s,o),a.restore();break}}a.restore(),r&&r.width>0&&(a.save(),a.strokeStyle=r.color,a.lineWidth=r.width,a.beginPath(),N(a,H,X,s,o,m,y),a.stroke(),a.restore()),n.label&&(a.font="bold 14px sans-serif",a.fillStyle="#fff",a.fillText(n.label,H+4,X+16)),n.description&&(a.font="12px sans-serif",a.fillStyle="#fff",a.fillText(n.description,H+4,X+o-6)),a.restore()}function nt(a,t="both"){const n=a.map(g=>g.width),f=a.map(g=>g.height);n.sort((g,r)=>g-r),f.sort((g,r)=>g-r);const x=Math.floor(a.length/2);return{width:t==="height"?0:n[x],height:t==="width"?0:f[x]}}const V=3200;function ot({loadedImages:a,images:t,normalizeSize:n,layout:f,spacing:x=0,fit:g=!1,scale:r=1,justify:v=!1}){if(!a||!a.length||a.length!==t.length)return{canvasWidth:1,canvasHeight:1,items:[]};let l={width:0,height:0};if(n){let s="both";f==="single-row"?s="height":(f==="single-column"||f==="masonry")&&(s="width"),l=nt(a,s)}const u=a.map(s=>{let o=s.width,M=s.height;if(n){if(f==="single-row"&&l.height)o=Math.round(l.height*(o/M)),M=l.height;else if((f==="single-column"||f==="masonry")&&l.width)M=Math.round(l.width*(M/o)),o=l.width;else if(l.width&&l.height){const W=o/M;W>l.width/l.height?(o=l.width,M=Math.round(l.width/W)):(M=l.height,o=Math.round(l.height*W))}}return{w:o,h:M}}),y=u.reduce((s,o)=>s+o.w,0)/u.length,C=u.reduce((s,o)=>s+o.h,0)/u.length,Y=x/100*.5,A=Math.round(Y*((y+C)/2)),d=(()=>{switch(f){case"single-row":return st(a,u,A,g);case"single-column":return rt(a,u,A,g);case"grid":return ht(a,u,A,g,v);case"masonry":return lt(a,u,A,g,v);case"packed":return ft(u,A,v);case"cluster":return mt(u,A);case"squarified":return ut(u,A);case"lanes":return it(a,u,A,g,v);case"bubble":return ct(a,u,A);default:return{canvasWidth:800,canvasHeight:600,items:[]}}})(),w=Math.min(V/d.canvasWidth,V/d.canvasHeight),S={canvasWidth:d.canvasWidth*w,canvasHeight:d.canvasHeight*w,items:d.items.map(s=>({...s,x:s.x*w,y:s.y*w,w:s.w*w,h:s.h*w}))};return{canvasWidth:S.canvasWidth*r,canvasHeight:S.canvasHeight*r,items:S.items.map(s=>({...s,x:s.x*r,y:s.y*r,w:s.w*r,h:s.h*r}))}}function st(a,t,n=0,f=!1){const x=Math.max(...t.map(u=>u.h))+2*n;let g,r=[];if(f){const u=x-2*n;r=a.map(y=>Math.round(u*(y.width/y.height))),g=r.reduce((y,C,Y)=>y+C+(Y>0?n:0),0)+2*n}else g=t.reduce((u,y,C)=>u+y.w+(C>0?n:0),0)+2*n;const v=[];let l=n;return a.forEach((u,y)=>{const C=f?r[y]:t[y].w,Y=f?x-2*n:t[y].h;v.push({x:l,y:n,w:C,h:Y,imageIndex:y}),l+=C+n}),{canvasWidth:g,canvasHeight:x,items:v}}function rt(a,t,n=0,f=!1){const x=Math.max(...t.map(u=>u.w))+2*n;let g,r=[];if(f){const u=x-2*n;r=a.map(y=>Math.round(u*(y.height/y.width))),g=r.reduce((y,C,Y)=>y+C+(Y>0?n:0),0)+2*n}else g=t.reduce((u,y,C)=>u+y.h+(C>0?n:0),0)+2*n;const v=[];let l=n;return a.forEach((u,y)=>{if(f){const C=x-2*n,Y=r[y];v.push({x:(x-C)/2,y:l,w:C,h:Y,imageIndex:y}),l+=Y+n}else{const C=(x-2*n-t[y].w)/2+n;v.push({x:C,y:l,w:t[y].w,h:t[y].h,imageIndex:y}),l+=t[y].h+n}}),{canvasWidth:x,canvasHeight:g,items:v}}function ht(a,t,n=0,f=!1,x=!1){const g=a.length,r=Math.ceil(Math.sqrt(g)),v=Math.ceil(g/r),l=Math.max(...t.map(w=>w.w)),u=Math.max(...t.map(w=>w.h)),y=r*l+(r-1)*n+2*n,C=v*u+(v-1)*n+2*n,Y=[],A=g%r,d=A>0&&A<r;for(let w=0;w<g;++w){const S=w%r,s=Math.floor(w/r),o=s===v-1;if(x&&d&&o){const M=A,W=y-2*n,k=(M-1)*n,i=(W-k)/M,H=S*(i+n)+n,X=s*(u+n)+n;if(f)Y.push({x:H,y:X,w:i,h:u,imageIndex:w});else{const I=t[w].w,h=t[w].h,m=H+(i-I)/2,e=X+(u-h)/2;Y.push({x:m,y:e,w:I,h,imageIndex:w})}}else{const M=S*(l+n)+n,W=s*(u+n)+n;if(f)Y.push({x:M,y:W,w:l,h:u,imageIndex:w});else{const k=t[w].w,i=t[w].h,H=M+(l-k)/2,X=W+(u-i)/2;Y.push({x:H,y:X,w:k,h:i,imageIndex:w})}}}return{canvasWidth:y,canvasHeight:C,items:Y}}function lt(a,t,n=0,f=!1,x=!1){const g=a.length,r=Math.ceil(Math.sqrt(g)),v=Array(r).fill(0).map((i,H)=>Math.max(...t.filter((X,I)=>I%r===H).map(X=>X.w),0));for(let i=0;i<r-1;++i)v[i]+=n;const l=Array(r).fill(0),u=[],y=[];for(let i=0;i<g;++i){let H=0;for(let b=1;b<r;++b)l[b]<l[H]&&(H=b);const X=v.slice(0,H).reduce((b,c)=>b+c,0),I=v[H]-(H<r-1?n:0),h=l[H]+(l[H]>0?n:0);let m=t[i].w,e=t[i].h;f&&(m=I,e=Math.round(m*(a[i].height/a[i].width))),u.push({x:X+n,y:h+n,w:m,h:e,imageIndex:i}),l[H]+=e+(l[H]>0?n:0),y[i]=H}const C=v.reduce((i,H)=>i+H,0)+2*n,Y=Math.max(...l)+2*n;if(!x||g===0)return{canvasWidth:C,canvasHeight:Y,items:u};const A=Math.max(...l,0),d=Array.from({length:r},()=>[]);u.forEach((i,H)=>d[y[H]].push(H));const w=Array(r).fill(0),S=Array(g);for(let i=0;i<r;i++){const H=d[i];if(H.length===0)continue;const X=Math.max(0,H.length-1)*n,I=H.reduce((e,b)=>e+u[b].h,0),h=I>0?(A-X)/I:1;let m=n;for(const e of H){const b=u[e],c=b.w*h,p=b.h*h;S[e]={w:c,h:p,y:m},m+=p+n,w[i]=Math.max(w[i],c)}}const s=[];let o=n;for(let i=0;i<r;i++)s[i]=o,o+=(w[i]||0)+n;const M=u.map((i,H)=>{const X=y[H],I=S[H],h=w[X]||i.w;return{x:s[X]+(h-I.w)/2,y:I.y,w:I.w,h:I.h,imageIndex:i.imageIndex}}),W=Math.max(o,C),k=Math.max(A+n,Y);return{canvasWidth:W,canvasHeight:k,items:M}}function it(a,t,n=0,f=!1,x=!1){const g=a.length;if(g===0)return{canvasWidth:0,canvasHeight:0,items:[]};const r=Math.max(1,Math.ceil(Math.sqrt(g))),v=[],l=Array(r).fill(0),u=Array(r).fill(0),y=Array(g);for(let h=0;h<g;h++){let m=0;for(let b=1;b<r;b++)u[b]<u[m]&&(m=b);v.push({i:h,row:m}),y[h]=m;const e=t[h].h;l[m]=Math.max(l[m],e),u[m]+=t[h].w+(u[m]>0?n:0)}const C=[];let Y=n;for(let h=0;h<r;h++)C[h]=Y,Y+=l[h]+n;const A=Array(r).fill(0),d=Array(g);for(const{i:h,row:m}of v){const e=a[h].width/a[h].height,b=f?l[m]:t[h].h,c=f?Math.round(b*e):t[h].w,p=n+A[m],P=C[m];d[h]={x:p,y:P,w:c,h:b,imageIndex:h},A[m]+=c+n}const w=Math.max(...A,0)+n,S=Y;if(!x)return{canvasWidth:w,canvasHeight:S,items:d};const s=Math.max(...A,0),o=Array.from({length:r},()=>[]);d.forEach((h,m)=>o[y[m]].push(m));const M=Array(r).fill(0),W=Array(g);for(let h=0;h<r;h++){const m=o[h];if(m.length===0)continue;const e=m.length*n,b=m.reduce((P,$)=>P+d[$].w,0),c=b>0?(s-e)/b:1;let p=n;for(const P of m){const $=d[P],R=$.w*c,B=$.h*c;W[P]={w:R,h:B,x:p},p+=R+n,M[h]=Math.max(M[h],B)}}const k=[];let i=n;for(let h=0;h<r;h++)k[h]=i,i+=(M[h]||0)+n;const H=d.map((h,m)=>{const e=y[m],b=W[m],c=M[e]||h.h,p=k[e]+(c-b.h)/2;return{x:b.x,y:p,w:b.w,h:b.h,imageIndex:h.imageIndex}}),X=Math.max(s+n,w),I=Math.max(i,S);return{canvasWidth:X,canvasHeight:I,items:H}}function ct(a,t,n=0){const f=t.length;if(f===0)return{canvasWidth:0,canvasHeight:0,items:[]};const x=t.map((o,M)=>{const W=Math.min(o.w,o.h);return{i:M,side:W,r:W/2,x:0,y:0}}).sort((o,M)=>M.side-o.side),g=Math.PI*2/f,r=x[0].r+n;x.forEach((o,M)=>{const W=M*g,k=1+M%3*.05,i=r*k+M*.15*n;o.x=Math.cos(W)*i,o.y=Math.sin(W)*i});const v=220,l=n;for(let o=0;o<v;o++){for(let W=0;W<f;W++)for(let k=W+1;k<f;k++){const i=x[W],H=x[k];let X=H.x-i.x,I=H.y-i.y,h=Math.hypot(X,I);const m=i.r+H.r+l;if(h===0&&(X=.01,I=0,h=.01),h<m){const b=(m-h)/h*.5,c=X*b,p=I*b;i.x-=c,i.y-=p,H.x+=c,H.y+=p}}const M=.02;for(const W of x)W.x*=1-M,W.y*=1-M}let u=1/0,y=1/0,C=-1/0,Y=-1/0;for(const o of x)u=Math.min(u,o.x-o.r),y=Math.min(y,o.y-o.r),C=Math.max(C,o.x+o.r),Y=Math.max(Y,o.y+o.r);const A=-u+n,d=-y+n,w=C-u+n*2,S=Y-y+n*2,s=x.map(o=>({x:o.x-o.r+A,y:o.y-o.r+d,w:o.side,h:o.side,imageIndex:o.i}));return s.sort((o,M)=>o.imageIndex-M.imageIndex),{canvasWidth:w,canvasHeight:S,items:s}}function ft(a,t=0,n=!1){const f=a.reduce((e,b)=>e+b.w*b.h,0),x=Math.max(...a.map(e=>e.w)),g=Math.max(...a.map(e=>e.h));let r=Math.max(Math.ceil(Math.sqrt(f)),x),v=Math.max(Math.ceil(f/r),g);r+=t*2,v+=t*2;function l(e,b,c,p){return{x:e,y:b,w:c,h:p,used:!1,down:null,right:null,imgIdx:null}}function u(e,b,c,p){return e.used?u(e.right,b,c,p)||u(e.down,b,c,p):b<=e.w&&c<=e.h?(e.used=!0,e.imgIdx=p,e.down=l(e.x,e.y+c+t,e.w,e.h-c-t),e.right=l(e.x+b+t,e.y,e.w-b-t,c),{x:e.x,y:e.y}):null}const y=a.map((e,b)=>({i:b,w:e.w,h:e.h,key:Math.max(e.w,e.h),area:e.w*e.h})).sort((e,b)=>b.key-e.key||b.area-e.area),C=Array(a.length);let Y=!1,A=0,d=null;for(;!Y&&A<10;){d=l(t,t,r-2*t,v-2*t);let e=!1;for(let b=0;b<y.length;++b){const{w:c,h:p,i:P}=y[b],$=u(d,c,p,P);if(!$){e=!0;break}C[P]=$}e?(r<=v?r=Math.round(r*1.2):v=Math.round(v*1.2),A++):Y=!0}const w=a.map((e,b)=>({x:C[b].x,y:C[b].y,w:e.w,h:e.h,imageIndex:b}));if(!n||!d)return{canvasWidth:r,canvasHeight:v,items:w};function S(e){const b=[],c=[],p=e.right?S(e.right):null,P=e.down?S(e.down):null;p&&b.push(p),P&&b.push(P),e.right&&e.right.imgIdx!==null&&c.push(e.right.imgIdx),e.down&&e.down.imgIdx!==null&&c.push(e.down.imgIdx),e.imgIdx!==null&&c.push(e.imgIdx);const $=e.imgIdx!==null?(()=>{const T=w[e.imgIdx];return{minX:T.x,maxX:T.x+T.w,minY:T.y,maxY:T.y+T.h}})():null,R=[...b,...$?[$]:[]].reduce((T,q)=>T?{minX:Math.min(T.minX,q.minX),maxX:Math.max(T.maxX,q.maxX),minY:Math.min(T.minY,q.minY),maxY:Math.max(T.maxY,q.maxY)}:{...q},null);if(!R)return null;if(c.length===1&&e.imgIdx!==null){const T=e.imgIdx;return w[T]={...w[T],x:e.x,y:e.y,w:e.w,h:e.h},{minX:e.x,maxX:e.x+e.w,minY:e.y,maxY:e.y+e.h}}const O=R.maxX-R.minX,E=R.maxY-R.minY,_=O>0?e.w/O:1,D=E>0?e.h/E:1;function L(T){if(T.imgIdx!==null){const q=w[T.imgIdx];w[T.imgIdx]={...q,x:e.x+(q.x-R.minX)*_,y:e.y+(q.y-R.minY)*D,w:q.w*_,h:q.h*D}}T.right&&L(T.right),T.down&&L(T.down)}L(e);const F=e.x+(R.minX-R.minX)*_,G=e.x+(R.maxX-R.minX)*_,J=e.y+(R.minY-R.minY)*D,dt=e.y+(R.maxY-R.minY)*D;return{minX:F,maxX:G,minY:J,maxY:dt}}S(d);const s=Math.min(...w.map(e=>e.x),t),o=Math.max(...w.map(e=>e.x+e.w),t),M=Math.min(...w.map(e=>e.y),t),W=Math.max(...w.map(e=>e.y+e.h),t),k=o-s,i=W-M,H=r-t*2,X=v-t*2,I=k>0?H/k:1,h=i>0?X/i:1,m=w.map(e=>({x:t+(e.x-s)*I,y:t+(e.y-M)*h,w:e.w*I,h:e.h*h,imageIndex:e.imageIndex}));return{canvasWidth:r,canvasHeight:v,items:m}}function mt(a,t=0){const n=a.map((s,o)=>({...s,i:o,area:s.w*s.h}));n.sort((s,o)=>o.area-s.area);const f=[];f.push({x:0,y:0,w:n[0].w,h:n[0].h,i:n[0].i});let x=0,g=0,r=n[0].w,v=n[0].h;function l(){const s=[];return f.forEach((o,M)=>{s.push({x:o.x+o.w+t,y:o.y,align:"left",anchorIdx:M}),s.push({x:o.x-t,y:o.y,align:"right",anchorIdx:M}),s.push({x:o.x,y:o.y-t,align:"bottom",anchorIdx:M}),s.push({x:o.x,y:o.y+o.h+t,align:"top",anchorIdx:M}),s.push({x:o.x-t,y:o.y-t,align:"corner-topleft",anchorIdx:M}),s.push({x:o.x+o.w+t,y:o.y-t,align:"corner-topright",anchorIdx:M}),s.push({x:o.x-t,y:o.y+o.h+t,align:"corner-bottomleft",anchorIdx:M}),s.push({x:o.x+o.w+t,y:o.y+o.h+t,align:"corner-bottomright",anchorIdx:M})}),s}const u=f[0].x+f[0].w/2,y=f[0].y+f[0].h/2;function C(s,o,M){const W=s.x+o/2,k=s.y+M/2;return Math.sqrt((W-u)*(W-u)+(k-y)*(k-y))}for(let s=1;s<n.length;++s){const{w:o,h:M,i:W}=n[s];let k=1/0,i=null;const H=l();for(const X of H){const I=[{x:X.x,y:X.y},{x:X.x-o,y:X.y},{x:X.x,y:X.y-M},{x:X.x-o,y:X.y-M}];for(const h of I){let m=!1;for(const c of f)if(h.x<c.x+c.w+t&&h.x+o+t>c.x&&h.y<c.y+c.h+t&&h.y+M+t>c.y){m=!0;break}if(m)continue;let e=!1;for(const c of f)if(Math.abs(h.x+o+t-c.x)<1e-6&&h.y<c.y+c.h+t&&h.y+M>c.y||Math.abs(h.x-(c.x+c.w+t))<1e-6&&h.y<c.y+c.h+t&&h.y+M>c.y||Math.abs(h.y+M+t-c.y)<1e-6&&h.x<c.x+c.w+t&&h.x+o>c.x||Math.abs(h.y-(c.y+c.h+t))<1e-6&&h.x<c.x+c.w+t&&h.x+o>c.x){e=!0;break}if(!e)continue;const b=C(h,o,M);b<k&&(k=b,i=h)}}i||(i={x,y:v+t}),f.push({x:i.x,y:i.y,w:o,h:M,i:W}),x=Math.min(x,i.x),g=Math.min(g,i.y),r=Math.max(r,i.x+o),v=Math.max(v,i.y+M)}const Y=-x,A=-g,d=r-x+2*t,w=v-g+2*t,S=f.map(s=>({x:s.x+Y+t,y:s.y+A+t,w:a[s.i].w,h:a[s.i].h,imageIndex:s.i}));return{canvasWidth:d,canvasHeight:w,items:S}}function ut(a,t=0){const n=a.reduce((d,w)=>d+w.w*w.h,0),f=a.reduce((d,w)=>d+w.w/w.h,0)/a.length;let x=Math.sqrt(n/f),g=f*x;g=Math.round(g),x=Math.round(x);const r=a.map((d,w)=>({...d,i:w,area:d.w*d.h,x:0,y:0,rw:0,rh:0}));r.sort((d,w)=>w.area-d.area);function v(d,w){if(d.length===0||w===0)return 1/0;const s=d.reduce((M,W)=>M+W.area,0)/w;let o=0;for(const M of d){const W=M.area/s,k=Math.max(W/s,s/W);o=Math.max(o,k)}return o}function l(d,w,S,s,o){if(d.length===0)return;if(d.length===1){d[0].x=w,d[0].y=S,d[0].rw=s,d[0].rh=o;return}const M=s>o;let W=[],k=0;if(M){const i=s;for(let m=1;m<=d.length;m++){const e=d.slice(0,m),b=v(e,i);if(m===1)W=e,k=m;else{const c=v(d.slice(0,m-1),i);if(b<c)W=e,k=m;else break}}const X=W.reduce((m,e)=>m+e.area,0)/i;let I=w;for(const m of W){const e=m.area/X;m.x=I,m.y=S,m.rw=e-t,m.rh=X-t,I+=e}const h=d.slice(k);h.length>0&&l(h,w,S+X,s,o-X)}else{const i=o;for(let m=1;m<=d.length;m++){const e=d.slice(0,m),c=e.reduce((P,$)=>P+$.area,0)/i;let p=0;for(const P of e){const $=P.area/c,R=Math.max(c/$,$/c);p=Math.max(p,R)}if(m===1)W=e,k=m;else{const P=d.slice(0,m-1),R=P.reduce((O,E)=>O+E.area,0)/i;let B=0;for(const O of P){const E=O.area/R,_=Math.max(R/E,E/R);B=Math.max(B,_)}if(p<B)W=e,k=m;else break}}const X=W.reduce((m,e)=>m+e.area,0)/i;let I=S;for(const m of W){const e=m.area/X;m.x=w,m.y=I,m.rw=X-t,m.rh=e-t,I+=e}const h=d.slice(k);h.length>0&&l(h,w+X,S,s-X,o)}}const u=g-2*t,y=x-2*t;l(r,t,t,u,y);let C=0,Y=0;for(const d of r)C=Math.max(C,d.x+d.rw),Y=Math.max(Y,d.y+d.rh);g=Math.round(C+t),x=Math.round(Y+t);const A=r.map(d=>{const w=d.x,S=d.y,s=d.rw,o=d.rh;return{x:w,y:S,w:s,h:o,imageIndex:d.i}});return{canvasWidth:g,canvasHeight:x,items:A}}let K=null,j=null;self.onmessage=async a=>{if(a.data.type==="compose"){self.postMessage({type:"start"});try{const{offscreenCanvas:t,images:n,loadedImgs:f,options:x}=a.data,g={images:n,loadedImages:f,normalizeSize:x.normalizeSize,layout:x.layout,spacing:x.spacing,fit:x.fit,scale:x.scale,justify:x.justify},r=JSON.stringify({...g,images:g.images.map(y=>y.src),dims:g.loadedImages.map(y=>[y.width,y.height])});let v;K===r&&j?v=j:(v=ot(g),K=r,j=v),t.width=v.canvasWidth,t.height=v.canvasHeight;const l=t.getContext("2d");if(!l){self.postMessage({type:"error",error:"Failed to get 2d context from offscreen canvas"});return}Q(l,v,n,f,x);const u=t.transferToImageBitmap();self.postMessage({type:"complete",canvasWidth:t.width,canvasHeight:t.height,imageBitmap:u},{transfer:[u]})}catch(t){self.postMessage({type:"error",error:t instanceof Error?t.message:"Unknown error in draw worker"})}}}})();
