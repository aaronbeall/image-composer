(function(){"use strict";function z(e){let a=0;for(let t=0;t<e.length;t++)a=Math.imul(31,a)+e.charCodeAt(t)|0;return a>>>0}function B(e){let a=e|0;return()=>{a|=0,a=a+1831565813|0;let t=Math.imul(a^a>>>15,1|a);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}function E(e,a,t,s,{fit:o,backgroundColor:m="transparent",cornerRadius:l=0,borderEnabled:i=!1,borderWidth:n=0,borderColor:v="#ffffff",shadowEnabled:c=!1,shadowAngle:A=0,shadowDistance:p=0,shadowBlur:g=0,shadowColor:w="#000000",effects:$=[],jitterPosition:y=0,jitterSize:d=0,jitterRotation:f=0,shape:C="rect"}){if(e.canvas.width=a.canvasWidth,e.canvas.height=a.canvasHeight,e.clearRect(0,0,e.canvas.width,e.canvas.height),m&&m!=="transparent"){if(e.save(),e.globalAlpha=1,e.fillStyle=m,C==="circle"){const r=a.canvasWidth/2,k=a.canvasHeight/2,T=Math.min(a.canvasWidth,a.canvasHeight)/2;e.beginPath(),e.arc(r,k,T,0,Math.PI*2),e.fill()}else e.fillRect(0,0,e.canvas.width,e.canvas.height);e.restore()}const S=a.items.length?Math.max(...a.items.map(r=>Math.min(r.w,r.h))):0,I=l>0&&S>0?l/100*(S/2):0,u=a.items.length?a.items.reduce((r,k)=>r+Math.min(k.w,k.h),0)/a.items.length:0,M=i&&n>0&&u>0?{color:v,width:n/100*(u*.1)}:void 0,b=c&&(p>0||g>0)&&u>0?(()=>{const r=p/100*(u*.2),k=g/100*(u*.2),T=A*Math.PI/180;return{color:w,offsetX:r*Math.cos(T),offsetY:r*Math.sin(T),blur:k}})():void 0;for(const r of a.items){const k=t[r.imageIndex],T=k.id||k.src||`img-${r.imageIndex}`,P=B(z(String(T))^r.imageIndex),X=Math.min(r.w,r.h)*.25*(Math.max(0,y)/100),h=.3*(Math.max(0,d)/100),O=Math.max(0,f),D=Z=>(P()-.5)*2*Z,Y=1+D(h),q=D(X),V=D(X),J=D(O)*(Math.PI/180),K=r.x+r.w/2,L=r.y+r.h/2,R=r.w*Y,W=r.h*Y,N=K+q-R/2,Q=L+V-W/2;j(e,{...r,x:N,y:Q,w:R,h:W},t[r.imageIndex],s[r.imageIndex],{fit:o,cornerRadiusTargetPx:I,border:M,dropShadow:b,effects:$,rotationRad:J,shape:C})}}function H(e,a,t,s,o,m,l="rect"){if(l==="circle"){const i=Math.min(s,o)/2;e.arc(a+s/2,t+o/2,i,0,Math.PI*2),e.closePath();return}if(m>0){const i=Math.min(s,o)/2,n=Math.min(m,i);e.moveTo(a+n,t),e.lineTo(a+s-n,t),e.arcTo(a+s,t,a+s,t+n,n),e.lineTo(a+s,t+o-n),e.arcTo(a+s,t+o,a+s-n,t+o,n),e.lineTo(a+n,t+o),e.arcTo(a,t+o,a,t+o-n,n),e.lineTo(a,t+n),e.arcTo(a,t,a+n,t,n),e.closePath()}else e.rect(a,t,s,o)}function F(e,a,t,s,o,m,l="overlay"){const i=document.createElement("canvas");i.width=Math.max(1,Math.floor(s)),i.height=Math.max(1,Math.floor(o));const n=i.getContext("2d");if(!n)return;const v=n.createImageData(i.width,i.height),c=v.data,A=Math.max(0,Math.min(100,m))/100*64;for(let p=0;p<c.length;p+=4){const g=Math.random()<.5?0:255;c[p]=g,c[p+1]=g,c[p+2]=g,c[p+3]=A}n.putImageData(v,0,0),e.save(),e.globalCompositeOperation=l,e.drawImage(i,a,t,s,o),e.restore()}function G(e,a,t,s,o,m,l="overlay"){e.save();const i=a+s/2,n=t+o/2,v=Math.sqrt(s*s+o*o)/2,c=e.createRadialGradient(i,n,0,i,n,v);c.addColorStop(0,"rgba(0, 0, 0, 0)"),c.addColorStop(1,`rgba(0, 0, 0, ${m/100})`),e.globalCompositeOperation=l,e.fillStyle=c,e.beginPath(),e.rect(a,t,s,o),e.fill(),e.restore()}function U(e,a,t,s,o,m){const l=m/100,n=e.getImageData(a,t,s,o).data,v=s,c=o,A=[0,-l,0,-l,1+4*l,-l,0,-l,0],p=new Uint8ClampedArray(n);for(let g=1;g<c-1;g++)for(let w=1;w<v-1;w++){let $=0,y=0,d=0;for(let C=-1;C<=1;C++)for(let S=-1;S<=1;S++){const I=((g+C)*v+(w+S))*4,u=A[(C+1)*3+(S+1)];$+=n[I]*u,y+=n[I+1]*u,d+=n[I+2]*u}const f=(g*v+w)*4;p[f]=Math.max(0,Math.min(255,$)),p[f+1]=Math.max(0,Math.min(255,y)),p[f+2]=Math.max(0,Math.min(255,d))}e.putImageData(new ImageData(p,v,c),a,t)}function j(e,a,t,s,{fit:o,cornerRadiusTargetPx:m=0,border:l,dropShadow:i,effects:n=[],rotationRad:v=0,shape:c="rect"}){const{x:A,y:p,w:g,h:w}=a,$=s.width/s.height,y=g/w;let d=g,f=w,C=0,S=0,I=s.width,u=s.height;o?y>$?(I=s.width,u=I/y,S=(s.height-u)/2):(u=s.height,I=u*y,C=(s.width-I)/2):y>$?(d=w*$,f=w):(d=g,f=g/$);const M=A+(g-d)/2,b=p+(w-f)/2,r=M+d/2,k=b+f/2;e.save(),e.translate(r,k),v&&e.rotate(v),e.translate(-r,-k);const T=m>0?Math.min(m,Math.min(d,f)/2):0;i&&(e.save(),e.shadowColor=i.color,e.shadowBlur=i.blur,e.shadowOffsetX=i.offsetX,e.shadowOffsetY=i.offsetY,e.beginPath(),H(e,M,b,d,f,T,c),e.fillStyle="black",e.fill(),e.restore()),e.save();const P=[],X=[];if(n.length>0){for(const h of n)switch(h.type){case"blur":P.push(`blur(${h.value}px)`);break;case"brightness":P.push(`brightness(${h.value}%)`);break;case"contrast":P.push(`contrast(${h.value}%)`);break;case"grayscale":P.push(`grayscale(${h.value}%)`);break;case"hue-rotate":P.push(`hue-rotate(${h.value}deg)`);break;case"invert":P.push(`invert(${h.value}%)`);break;case"saturate":P.push(`saturate(${h.value}%)`);break;case"sepia":P.push(`sepia(${h.value}%)`);break;case"grain":case"vignette":case"sharpen":case"bloom":X.push(h);break}P.length>0&&(e.filter=P.join(" "))}e.beginPath(),H(e,M,b,d,f,T,c),e.clip(),e.drawImage(s,C,S,I,u,M,b,d,f);for(const h of X)switch(h.type){case"grain":F(e,M,b,d,f,h.value,h.blendMode??"overlay");break;case"vignette":G(e,M,b,d,f,h.value,h.blendMode??"overlay");break;case"sharpen":U(e,M,b,d,f,h.value);break;case"bloom":{const O=Math.max(0,Math.min(100,h.value))/100,D=Math.max(0,h.blur??10),Y=h.blendMode??"overlay";e.save(),e.globalCompositeOperation=Y,e.globalAlpha=O,e.filter=`blur(${D}px)`,e.drawImage(s,C,S,I,u,M,b,d,f),e.restore();break}}e.restore(),l&&l.width>0&&(e.save(),e.strokeStyle=l.color,e.lineWidth=l.width,e.beginPath(),H(e,M,b,d,f,T,c),e.stroke(),e.restore()),t.label&&(e.font="bold 14px sans-serif",e.fillStyle="#fff",e.fillText(t.label,M+4,b+16)),t.description&&(e.font="12px sans-serif",e.fillStyle="#fff",e.fillText(t.description,M+4,b+f-6)),e.restore()}self.onmessage=async e=>{if(e.data.type==="draw"){self.postMessage({type:"start"});try{const{offscreenCanvas:a,layoutResult:t,images:s,loadedImgs:o,options:m}=e.data,l=a.getContext("2d");if(!l){self.postMessage({type:"error",error:"Failed to get 2d context from offscreen canvas"});return}E(l,t,s,o,m);const i=a.transferToImageBitmap();self.postMessage({type:"complete",canvasWidth:a.width,canvasHeight:a.height,imageBitmap:i},{transfer:[i]})}catch(a){self.postMessage({type:"error",error:a instanceof Error?a.message:"Unknown error in draw worker"})}}}})();
